# Travonex Firebase Schema and Security Rules Guide

This document outlines the data structure (schema) for the Firestore database and provides a complete set of security rules to protect the data.

## 1. Firestore Data Schema

Our database is structured into four main collections: `users`, `posts`, `comments`, and `stories`.

### `users`

This collection stores extra information about users that isn't included in the standard Firebase Authentication user object, most importantly, their role.

-   **Document ID**: The user's `uid` from Firebase Authentication.
-   **Fields**:
    -   `name` (string): The user's display name.
    -   `email` (string): The user's email address.
    -   `role` (string): The user's role (`'admin'`, `'editor'`, or `'user'`). This is crucial for security rules.
    -   `createdAt` (timestamp): The date the user document was created.

### `posts`

This collection stores all blog articles.

-   **Document ID**: Auto-generated by Firestore.
-   **Fields**:
    -   `title` (string): The title of the article.
    -   `slug` (string): A URL-friendly version of the title.
    -   `content` (string): The full HTML content of the article.
    -   `excerpt` (string): A short summary of the article.
    -   `authorId` (string): The `uid` of the user who wrote the post.
    -   `status` (string): Moderation status (`'draft'`, `'pending'`, `'published'`, `'rejected'`).
    -   `featuredImgUrl` (string): URL of the post's main image.
    -   `createdAt` (timestamp): The date the post was created.
    -   `updatedAt` (timestamp): The date the post was last updated.

### `comments`

This collection stores all comments submitted on posts.

-   **Document ID**: Auto-generated by Firestore.
-   **Fields**:
    -   `postId` (string): The ID of the post this comment belongs to.
    -   `userId` (string): The `uid` of the user who wrote the comment.
    -   `commentText` (string): The text content of the comment.
    -   `imageUrl` (string, optional): URL of an image attached to the comment.
    -   `status` (string): Moderation status (`'pending'`, `'approved'`, `'rejected'`).
    -   `createdAt` (timestamp): The date the comment was submitted.

### `stories`

This collection stores all follow-up stories submitted on posts.

-   **Document ID**: Auto-generated by Firestore.
-   **Fields**:
    -   `postId` (string): The ID of the post this story is related to.
    -   `userId` (string): The `uid` of the user who submitted the story.
    -   `storyText` (string): The text content of the story.
    -   `imageUrl` (string, optional): URL of an image attached to the story.
    -   `status` (string): Moderation status (`'pending'`, `'approved'`, `'rejected'`).
    -   `createdAt` (timestamp): The date the story was submitted.

---

## 2. Firestore Security Rules

These rules protect your data from unauthorized access. They should be copied into the **Rules** tab of your Firestore database in the Firebase Console.

```javascript
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    
    // Checks if the requesting user is authenticated.
    function isAuthenticated() {
      return request.auth != null;
    }

    // Gets the role of a user from the 'users' collection.
    // This is the core of our role-based access control.
    function getUserRole(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.role;
    }

    // Checks if the requesting user is an admin.
    function isAdmin() {
      return isAuthenticated() && getUserRole(request.auth.uid) == 'admin';
    }
    
    // Checks if the requesting user is a moderator (admin or editor).
    function isModerator() {
      return isAuthenticated() && getUserRole(request.auth.uid) in ['admin', 'editor'];
    }

    // --- Collection Rules ---

    // USERS collection:
    // - Anyone can create their own user document on signup.
    // - Authenticated users can read their own data.
    // - Admins can read/write any user document (for managing roles).
    match /users/{userId} {
      allow read: if request.auth.uid == userId || isAdmin();
      allow create: if request.auth.uid == userId;
      allow update: if isAdmin();
      // No delete access for now to prevent accidental data loss.
    }

    // POSTS collection:
    // - Anyone (even unauthenticated users) can read published posts.
    // - Moderators can read posts with any status.
    // - Any authenticated user can create a new post (it will default to 'pending').
    // - Only moderators can update posts (e.g., change status, edit content).
    // - Only admins can delete posts.
    match /posts/{postId} {
      allow read: if resource.data.status == 'published' || isModerator();
      allow create: if isAuthenticated();
      allow update: if isModerator();
      allow delete: if isAdmin();
    }

    // COMMENTS and STORIES collections:
    // - Anyone can read approved comments/stories.
    // - Moderators can read all comments/stories, regardless of status.
    // - Any authenticated user can create new comments/stories.
    // - Moderators can update the status of any comment/story.
    // - Users can update or delete their OWN submissions.
    // - Admins can delete any comment/story.
    match /{collection}/{docId} where collection in ['comments', 'stories'] {
       allow read: if resource.data.status == 'approved' || isModerator();
       allow create: if isAuthenticated();
       allow update: if isModerator() || (isAuthenticated() && request.auth.uid == resource.data.userId);
       allow delete: if isAdmin() || (isAuthenticated() && request.auth.uid == resource.data.userId);
    }
  }
}
```

## 3. How Helper Functions Map to Schema

The helper functions in `src/lib/firestore.ts` and `src/lib/storage.ts` are designed to work directly with this schema.

-   `getPosts('published')` queries the `posts` collection where the `status` field is `'published'`.
-   `addComment()` creates a new document in the `comments` collection with a default `status` of `'pending'`.
-   `approveComment(id)` finds a document in the `comments` collection by its ID and uses `updateDoc` to set its `status` to `'approved'`.
-   `uploadImage(file, path)` uploads a file to Firebase Storage, which is separate from Firestore. The returned URL is then typically stored in an `imageUrl` field in a Firestore document (like in the `comments` or `stories` collections).

By using these helper functions, the rest of the application code remains clean and doesn't need to know the specific details of the Firestore API.
